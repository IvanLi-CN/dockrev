name: Release

on:
  workflow_run:
    workflows: ["CI (main)"]
    types: [completed]
    branches: [main]

permissions:
  contents: write
  packages: write
  issues: read
  pull-requests: read

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: dockrev
  PLATFORMS: linux/amd64,linux/arm64
  RUST_TOOLCHAIN: "1.91.0"

concurrency:
  group: release-${{ github.event.workflow_run.head_branch }}

jobs:
  prepare:
    name: Prepare (version + tag)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event.workflow_run.conclusion == 'success'
    outputs:
      app_effective_version: ${{ steps.meta.outputs.app_effective_version }}
      release_tag: ${{ steps.meta.outputs.release_tag }}
      should_release: ${{ steps.meta.outputs.should_release }}
      bump_level: ${{ steps.meta.outputs.bump_level }}
      pr_number: ${{ steps.meta.outputs.pr_number }}
      pr_url: ${{ steps.meta.outputs.pr_url }}
      release_intent_label: ${{ steps.meta.outputs.release_intent_label }}
      reason: ${{ steps.meta.outputs.reason }}
    steps:
      - name: Checkout (workflow_run)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Determine release intent (labels)
        id: intent
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKFLOW_RUN_SHA: ${{ github.event.workflow_run.head_sha }}
        run: bash ./.github/scripts/release-intent.sh

      - name: Compute effective version (label-driven)
        if: ${{ steps.intent.outputs.should_release == 'true' }}
        shell: bash
        env:
          BUMP_LEVEL: ${{ steps.intent.outputs.bump_level }}
        run: bash ./.github/scripts/compute-version.sh

      - name: Export release metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          echo "should_release=${{ steps.intent.outputs.should_release }}" >> "$GITHUB_OUTPUT"
          echo "bump_level=${{ steps.intent.outputs.bump_level }}" >> "$GITHUB_OUTPUT"
          echo "pr_number=${{ steps.intent.outputs.pr_number }}" >> "$GITHUB_OUTPUT"
          echo "pr_url=${{ steps.intent.outputs.pr_url }}" >> "$GITHUB_OUTPUT"
          echo "release_intent_label=${{ steps.intent.outputs.release_intent_label }}" >> "$GITHUB_OUTPUT"
          echo "reason=${{ steps.intent.outputs.reason }}" >> "$GITHUB_OUTPUT"

          if [[ "${{ steps.intent.outputs.should_release }}" == "true" ]]; then
            echo "app_effective_version=${APP_EFFECTIVE_VERSION}" >> "$GITHUB_OUTPUT"
            echo "release_tag=${APP_EFFECTIVE_VERSION}" >> "$GITHUB_OUTPUT"
          else
            echo "app_effective_version=" >> "$GITHUB_OUTPUT"
            echo "release_tag=" >> "$GITHUB_OUTPUT"
          fi

      - name: Configure Git user
        if: ${{ steps.intent.outputs.should_release == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag (if missing)
        if: ${{ steps.intent.outputs.should_release == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          tag="${APP_EFFECTIVE_VERSION}"
          echo "target tag: $tag"
          if git rev-parse -q --verify "refs/tags/${tag}" >/dev/null; then
            echo "Tag ${tag} already exists. Skipping push."
          else
            git tag -a "${tag}" -m "${tag}"
            git push origin "${tag}"
          fi

  build-web:
    name: Build web dist
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [prepare]
    if: ${{ needs.prepare.outputs.should_release == 'true' }}
    env:
      APP_EFFECTIVE_VERSION: ${{ needs.prepare.outputs.app_effective_version }}
    steps:
      - name: Checkout (workflow_run)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.6

      - name: Build web (optional)
        shell: bash
        run: |
          set -euo pipefail
          if [[ -f web/package.json ]]; then
            cd web
            bun install --frozen-lockfile
            bun run build
          else
            echo "No web/ package; skipping"
          fi

      - name: Upload web dist artifact (if present)
        if: ${{ hashFiles('web/dist/**') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: web-dist-${{ github.event.workflow_run.head_sha }}
          path: web/dist

  build-binaries-amd64:
    name: Build binaries (amd64)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [prepare, build-web]
    if: ${{ needs.prepare.outputs.should_release == 'true' }}
    env:
      APP_EFFECTIVE_VERSION: ${{ needs.prepare.outputs.app_effective_version }}
      CARGO_TARGET_DIR: target/ci/amd64
    steps:
      - name: Checkout (workflow_run)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Download web dist artifact (best-effort)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: web-dist-${{ github.event.workflow_run.head_sha }}
          path: web/dist

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y musl-tools pkg-config libsqlite3-dev

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Cache cargo directories
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ${{ env.CARGO_TARGET_DIR }}
          key: ${{ runner.os }}-cargo-${{ env.RUST_TOOLCHAIN }}-${{ hashFiles('Cargo.lock') }}-${{ github.job }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ env.RUST_TOOLCHAIN }}-

      - name: Add musl target
        run: rustup target add x86_64-unknown-linux-musl

      - name: Build release binaries (linux/amd64)
        shell: bash
        run: |
          set -euo pipefail
          cargo build -p dockrev-api --bin dockrev --release --locked
          cargo build -p dockrev-api --bin dockrev --release --locked --target x86_64-unknown-linux-musl
          cargo build -p dockrev-supervisor --bin dockrev-supervisor --release --locked
          cargo build -p dockrev-supervisor --bin dockrev-supervisor --release --locked --target x86_64-unknown-linux-musl

      - name: Stage docker artifact (linux/amd64 musl)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist/ci/docker/amd64
          cp target/ci/amd64/x86_64-unknown-linux-musl/release/dockrev dist/ci/docker/amd64/dockrev
          cp target/ci/amd64/x86_64-unknown-linux-musl/release/dockrev-supervisor dist/ci/docker/amd64/dockrev-supervisor

      - name: Smoke test (linux/amd64 musl)
        shell: bash
        env:
          DOCKREV_SMOKE_BIN: dist/ci/docker/amd64/dockrev
          APP_EFFECTIVE_VERSION: ${{ env.APP_EFFECTIVE_VERSION }}
        run: bash ./.github/scripts/smoke-test.sh

      - name: Upload binaries artifact (amd64)
        uses: actions/upload-artifact@v4
        with:
          name: binaries-amd64-${{ github.event.workflow_run.head_sha }}
          path: |
            target/ci/amd64/release/dockrev
            target/ci/amd64/x86_64-unknown-linux-musl/release/dockrev
            target/ci/amd64/release/dockrev-supervisor
            target/ci/amd64/x86_64-unknown-linux-musl/release/dockrev-supervisor
            dist/ci/docker/amd64/dockrev
            dist/ci/docker/amd64/dockrev-supervisor

  build-binaries-arm64:
    name: Build binaries (arm64)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 45
    needs: [prepare, build-web]
    if: ${{ needs.prepare.outputs.should_release == 'true' }}
    env:
      APP_EFFECTIVE_VERSION: ${{ needs.prepare.outputs.app_effective_version }}
      CARGO_TARGET_DIR: target/ci/arm64
    steps:
      - name: Checkout (workflow_run)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Download web dist artifact (best-effort)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: web-dist-${{ github.event.workflow_run.head_sha }}
          path: web/dist

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y musl-tools pkg-config libsqlite3-dev

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Cache cargo directories
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ${{ env.CARGO_TARGET_DIR }}
          key: ${{ runner.os }}-cargo-${{ env.RUST_TOOLCHAIN }}-${{ hashFiles('Cargo.lock') }}-${{ github.job }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ env.RUST_TOOLCHAIN }}-

      - name: Add musl target
        run: rustup target add aarch64-unknown-linux-musl

      - name: Build release binaries (linux/arm64)
        shell: bash
        run: |
          set -euo pipefail
          cargo build -p dockrev-api --bin dockrev --release --locked
          cargo build -p dockrev-api --bin dockrev --release --locked --target aarch64-unknown-linux-musl
          cargo build -p dockrev-supervisor --bin dockrev-supervisor --release --locked
          cargo build -p dockrev-supervisor --bin dockrev-supervisor --release --locked --target aarch64-unknown-linux-musl

      - name: Stage docker artifact (linux/arm64 musl)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist/ci/docker/arm64
          cp target/ci/arm64/aarch64-unknown-linux-musl/release/dockrev dist/ci/docker/arm64/dockrev
          cp target/ci/arm64/aarch64-unknown-linux-musl/release/dockrev-supervisor dist/ci/docker/arm64/dockrev-supervisor

      - name: Upload binaries artifact (arm64)
        uses: actions/upload-artifact@v4
        with:
          name: binaries-arm64-${{ github.event.workflow_run.head_sha }}
          path: |
            target/ci/arm64/release/dockrev
            target/ci/arm64/aarch64-unknown-linux-musl/release/dockrev
            target/ci/arm64/release/dockrev-supervisor
            target/ci/arm64/aarch64-unknown-linux-musl/release/dockrev-supervisor
            dist/ci/docker/arm64/dockrev
            dist/ci/docker/arm64/dockrev-supervisor

  publish:
    name: Publish (GHCR + GitHub Release)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: [prepare, build-binaries-amd64, build-binaries-arm64]
    if: ${{ needs.prepare.outputs.should_release == 'true' }}
    env:
      APP_EFFECTIVE_VERSION: ${{ needs.prepare.outputs.app_effective_version }}
      RELEASE_TAG: ${{ needs.prepare.outputs.release_tag }}
    steps:
      - name: Checkout (workflow_run)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Download binaries (amd64)
        uses: actions/download-artifact@v4
        with:
          name: binaries-amd64-${{ github.event.workflow_run.head_sha }}
          path: .

      - name: Download binaries (arm64)
        uses: actions/download-artifact@v4
        with:
          name: binaries-arm64-${{ github.event.workflow_run.head_sha }}
          path: .

      - name: Package release assets
        shell: bash
        run: |
          set -euo pipefail
          out_dir="dist/release"
          mkdir -p "${out_dir}"
          ver="${APP_EFFECTIVE_VERSION}"

          package() {
            local arch="$1"
            local libc="$2"
            local bin="$3"
            if [[ ! -f "${bin}" ]]; then
              echo "missing binary: ${bin}" >&2
              exit 1
            fi
            local base="dockrev_${ver}_linux_${arch}_${libc}.tar.gz"
            tar -czf "${out_dir}/${base}" -C "$(dirname "${bin}")" dockrev
            sha256sum "${out_dir}/${base}" > "${out_dir}/${base}.sha256"
            echo "[assets] ${base} ($(stat -c%s "${out_dir}/${base}") bytes)"
          }

          package amd64 gnu target/ci/amd64/release/dockrev
          package arm64 gnu target/ci/arm64/release/dockrev
          package amd64 musl target/ci/amd64/x86_64-unknown-linux-musl/release/dockrev
          package arm64 musl target/ci/arm64/aarch64-unknown-linux-musl/release/dockrev

          ls -lah "${out_dir}"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute image tags
        id: docker-tags
        shell: bash
        run: |
          set -euo pipefail
          owner="${GITHUB_REPOSITORY_OWNER,,}"
          image="${REGISTRY}/${owner}/${IMAGE_NAME}"
          echo "image=${image}" >> "$GITHUB_OUTPUT"
          {
            echo "tags<<EOF"
            echo "${image}:${APP_EFFECTIVE_VERSION}"
            echo "${image}:latest"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Build and push Docker image (artifact-first)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          target: runtime-prebuilt
          platforms: ${{ env.PLATFORMS }}
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max,ignore-error=true
          tags: ${{ steps.docker-tags.outputs.tags }}
          labels: |
            org.opencontainers.image.version=${{ env.APP_EFFECTIVE_VERSION }}
            org.opencontainers.image.revision=${{ github.event.workflow_run.head_sha }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
          build-args: |
            APP_EFFECTIVE_VERSION=${{ env.APP_EFFECTIVE_VERSION }}

      - name: Create or update GitHub Release + upload assets
        id: github-release
        continue-on-error: true
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TAG }}
          generateReleaseNotes: true
          allowUpdates: true
          replacesArtifacts: true
          artifactErrorsFailBuild: true
          artifacts: |
            dist/release/*.tar.gz
            dist/release/*.sha256

      - name: Fail if GitHub Release step failed
        if: steps.github-release.outcome != 'success'
        shell: bash
        run: |
          set -euo pipefail
          echo "::error::GitHub Release create/update/upload failed after GHCR image push."
          echo "::error::Cause: see step 'Create or update GitHub Release + upload assets' logs above."
          echo "::error::Retry: Actions → workflow 'Release' → Re-run jobs (tag=${RELEASE_TAG})."
          exit 1
